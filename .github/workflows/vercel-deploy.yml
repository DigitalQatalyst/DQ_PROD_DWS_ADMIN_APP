name: ðŸš€ Deploy to Vercel (Prod + Preview)

on:
  push:
    branches:
      - main
      - "feature/**"
      - develop
      - "fix/**"
      - "hotfix/**"
      - "develop-staging"
      - "staging"
      - "release"
      - "feat/**"
      - "Stage**"
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“Š Extract commit info
        id: commit_info
        run: |
          AUTHOR_NAME="${{ github.event.head_commit.author.name }}"
          AUTHOR_EMAIL="${{ github.event.head_commit.author.email }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "author_name=$AUTHOR_NAME" >> $GITHUB_OUTPUT
          echo "author_email=$AUTHOR_EMAIL" >> $GITHUB_OUTPUT
          echo "ðŸ” Commit by: $AUTHOR_NAME ($AUTHOR_EMAIL)"

      - name: ðŸ§° Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build project
        run: npm run build
        env:
          NODE_ENV: production

      - name: âš™ï¸ Install Vercel CLI
        run: npm install -g vercel@latest

      # CRITICAL: Create .vercel directory with project linking BEFORE pulling
      - name: ðŸ”§ Link to Vercel Project
        run: |
          mkdir -p .vercel
          echo "{\"projectId\":\"${{ secrets.VERCEL_PROJECT_ID }}\",\"orgId\":\"${{ secrets.VERCEL_ORG_ID }}\"}" > .vercel/project.json
          cat .vercel/project.json
          echo "âœ… Linked to Vercel project: dq-intranet"

      - name: ðŸ”— Pull Vercel environment
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: ðŸ—ï¸ Build with Vercel
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          else
            vercel build --token=${{ secrets.VERCEL_TOKEN }}
          fi

      - name: ðŸŒ Deploy to Vercel
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          BRANCH_NAME: ${{ github.ref_name }}
          AUTHOR_NAME: ${{ steps.commit_info.outputs.author_name }}
          AUTHOR_EMAIL: ${{ steps.commit_info.outputs.author_email }}
        run: |
          echo "ðŸ” Branch: $BRANCH_NAME"
          echo "ðŸ‘¤ Deployed by: $AUTHOR_NAME ($AUTHOR_EMAIL)"
          echo "ðŸ“¦ Project ID: $VERCEL_PROJECT_ID"
          
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ðŸš€ Deploying PRODUCTION build..."
            DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN)
            echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
            echo "âœ… Production deployed at: $DEPLOY_URL"
          else
            echo "ðŸ§ª Deploying PREVIEW build for branch: $BRANCH_NAME"
            DEPLOY_URL=$(vercel deploy --prebuilt --token=$VERCEL_TOKEN)
            echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
            echo "âœ… Preview deployed at: $DEPLOY_URL"
          fi

      - name: ðŸ’¬ Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const deployUrl = '${{ steps.deploy.outputs.deploy_url }}';
            const author = '${{ steps.commit_info.outputs.author_name }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **Preview Deployment Ready!**\n\nâœ¨ Deployed by: **${author}**\nðŸ”— Preview URL: ${deployUrl}\n\n_Deployment triggered by commit ${context.sha.substring(0, 7)}_`
            });

      - name: ðŸ“ Deployment summary
        run: |
          echo "## ðŸŽ‰ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ steps.commit_info.outputs.author_name }} (${{ steps.commit_info.outputs.author_email }})" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deploy.outputs.deploy_url }}" >> $GITHUB_STEP_SUMMARY
